### 延迟中心

为什么要做超时中心：
现有产品存在很多生命周期的设计，如订单、优惠券、支付、入住延时、定时任务场景等等，时间到了做某些事。
常见的处理方式一般是将任务放入DB，然后定时从数据库扫描，交给业务处理器，处理完成后修改任务状态。优点是系统内部管理，延迟低，通过分库分表能存储海量数据。

缺点 1.定时任务间隔影响任务调度，容易延迟。2.为避免任务重复触发，造成并发度受限制。3.当单表数据量大时，会影响查询未执行任务队列，从而影响整个系统的稳定性。

1.解耦成通用组件，业务不用再关心如何启动、重试、回溯，只专注业务。
2.方便业务低沉本接入
3.灵活利用中间件
MQ 削峰填谷
Redis 高性能
MySQL 持久化
4.广播消息

总结：消息暂存的功能，弥补Kafka不能实现延迟消息，直接修改、优化消息中间件（1.职责不同，2.风险大，3.影响范围广）

市面上的是如何做的：
阿里云技术
超时中心 - 针对项目内自维护超时队列
基于Redis的三个队列
Store Queue
临时存储队列，无业务形态
Prepare Queue
准备队列
Dead Queue
死信队列
美团
Makfa 基于对消息中间件的重构
蘑菇街
延迟中心设计

吸取了哪些好的设计经验?做了哪些优化？
美团的Makfa
1.优先级消息
通常是需要区别对待消息的消费时间要求，后到的消息因为优先级比较高，需要尽可能早的消费，不同优先级的消息到达后，需要按设定好的优先级顺序消费。
TC实现方案，针对工作线程池处理具有优先级等级的任务
(1)实现一个优先级队列，继承PriorityBlockingQueue
(2)继承 ThreadPoolExecutor,重写submit方法
(3)提交任务后，如果需要放入队列，则会对任务进行优先级判断，正常任务放队尾。
2.至少消费一次
可通过配置化，可需要记录消费者消息的结果
TC实现
(1)所有需要消费者添加注解@TC
(3)因提交超时任务需要注册RPC和引入jar，在jar内部注册消费者，并注入bean内
(2)AOP 拦截，调用提前注册的服务，返回消费成功
3.消息回溯
可选择消息进行回溯
4.利用Redis的高性能
为什么没使用
5.宕机后重启 - 数据重新插入
每台服务器启动都会去DB获取一个ID,优先会覆盖
6.历史数据存档
每月生产SQL日志文件

能力边界
单机 QPS1000上下
所以对服务进行限流，使用的是guava开源的令牌桶算法。
消息延迟
因为从时间轮到期到查询Redis，再投放到MQ，最后消费消息，不拥堵的情况下 也会延迟10数毫秒。
消息重复风险
需要由业务方完成消息幂等校验，消息会根据配置重试
大批量数据插入风险
当单业务量超过服务可承受复杂50%，即QOS超过500后，对其进行限流
业务隔离
大流量业务动态生成一个时间轮进行任务调度

分布式协调问题
宕机，时间轮重溯 如何均匀的将任务分摊到所有的服务器
持久化数据到DB时，进行标识如TID，服务器启动时从DB随机获取一个ZID
动态扩容服务器，如何分担现有的服务器压力
1.手动下线旧服务，所有请求都发送到新的服务器
2.手动调整任务，删除时间轮内的任务，修改DB中TID为新服务器，通过初始化方法，将对应的数据放入时间轮中

删除任务问题
删除任务请求会在任意的服务器接收到请求，只删除Redis,同时修改DB状态
当时间轮到期后，会查询Redis,如果Redis没有，可能是任务取消或仅是Redis中没有，查询DB确认。

延时中心是一款用于解决延迟调度和并发限制的中间件，引入该中间后可以提升系统的整体性能和稳定性，可维护性。
在日常开发和重构的过程中，发现有很多定时场景，如订单延迟支付取消、优惠券定时发布，如果继续选择传统的方式，虽然实现简单，但存在业务延迟、并发限制和查询效率低下的问题。所以我在调研了市面上的常见的解决方案，如阿里云技术介绍的低延迟超时中心实现、美团的消息中间件Makfa，还有我的老东家蘑菇街的超时中心，吸取了很多优秀的设计经验，结合我们的业务特性和现有技术框架，设计了这款延迟中心。业务团队不需要再关注任务的启动、重试、回溯，只需要专注于业务逻辑特性，形成互补优势。
延迟中心的核心组件
1.后端管理，配置业务类型
包括优先级、任务投放Topic、重试机制、消息责任人
用于消息回溯，任务状态查看，死信队列管理
管理员后台功能，任务的ZID设置
2.任务管理器
通过时间轮管理任务
完成分布式重启后
3.Client 服务端
4.MQ、解耦开业务和系统，削峰填谷
5.Redis 提高性能
6.Mysql 持久化数据
7.Dubbo 用于服务间通信

同时系统也能力边界
1.单机QPS 在1100上下，通过限流算法控制压力
2.消息延迟，在理想情况下也会延迟数毫秒
3.同时因为基于MQ消息，要求业务方实现消息幂等校验
4.服务宕机重启会造成消息一定时间的滞后
5.针对历史消息，会定期迁移

